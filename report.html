<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice/Statement Generator</title>
  <style>
     body {
    font-family: Arial, sans-serif;
    max-width: 1000px;
    margin: 0 auto;
    background-color: #acdbf9; /* Light blue background */
    color: #333;
    padding-top: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
  }
  button {
    display: inline-block;
    padding: 12px 24px;
    background-color: #f8c9f9; /* Soft pink */
    color: #333;
    font-size: 1rem;
    font-weight: bold;
    border: 1px solid #000;
    border-radius: 30px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin: 10px;
  }

  button:hover {
    background-color: #e8b3e8; /* Slightly darker pink */
  }

  button:disabled {
    background-color: #f0d4f0; /* Dimmed pink */
    color: #999;
    cursor: not-allowed;
    border: 1px solid #999;
  }

  /* File Input Styling */
  input[type="file"] {
    padding: 12px 24px;
    font-size: 1rem;
    border: 1px solid #000;
    border-radius: 30px;
    background-color: #f8c9f9;
    color: #333;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin: 10px;
  }

  input[type="file"]:hover {
    background-color: #e8b3e8;
  }

  input[type="file"]::file-selector-button {
    background-color: #f8c9f9;
    color: #333;
    border: 1px solid #000;
    padding: 10px 20px;
    border-radius: 30px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease;
  }

  input[type="file"]::file-selector-button:hover {
    background-color: #e8b3e8;
  }

  /* Back Home Button */
  .back-home {
    display: inline-block;
    padding: 12px 24px;
    background-color: #f8c9f9;
    color: #333;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    border-radius: 30px;
    text-align: center;
    border: 1px solid #000;
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 999;
    transition: background-color 0.2s ease;
  }

  .back-home:hover {
    background-color: #e8b3e8;
  }
</style>
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <a href="index.html" class="back-home">Back to Home</a>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button id="exportExcelBtn" onclick="exportToExcel()" disabled>Export to Excel</button>

  <script>
    let sheets = [];
    
async function extractClientInfo(lines) {
  let clientInfo = {};

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes(",")) { // Assume lastname, firstname format
      clientInfo.name = lines[i].trim();
      clientInfo.address = lines.slice(i + 1, i + 4).join('<br>').trim();
      break;
    }
  }

  document.getElementById('clientInfo').innerHTML = `<strong>Client Name:</strong><br>${clientInfo.name}<br><br><strong>Address:</strong><br>${clientInfo.address}`;
}
    document.getElementById('fileInput').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdfData = new Uint8Array(arrayBuffer);

          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
          const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

          sheets = [];
          let currentSheetData = [];

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();

            let line = '';
            let lastY = null;

            textContent.items.forEach((item) => {
              if (lastY !== null && Math.abs(item.transform[5] - lastY) > 10) {
                line = cleanText(line);

                // If the disclaimer is found, create a new sheet
                if (line.includes("Disclaimer: Charges/Adjustments made after statement date")) {
                  if (currentSheetData.length > 0) {
                    sheets.push([...currentSheetData]);
                    currentSheetData = [];
                  }
                } else {
                  currentSheetData.push([line.trim()]);
                }

                line = '';
              }

              line += item.str + ' ';
              lastY = item.transform[5];
            });

            // Capture remaining data after parsing the page
            if (line.trim()) {
              line = cleanText(line);
              if (line.includes("Disclaimer: Charges/Adjustments made after statement date")) {
                if (currentSheetData.length > 0) {
                  sheets.push([...currentSheetData]);
                  currentSheetData = [];
                }
              } else {
                currentSheetData.push([line.trim()]);
              }
            }
          }

          // If thereâ€™s leftover data after the last page, save it as a new sheet
          if (currentSheetData.length > 0) {
            sheets.push([...currentSheetData]);
          }

          console.log('Extracted Sheets:', sheets);
          if (sheets.length > 0) {
            alert('PDF data extracted successfully!');
            document.getElementById('exportExcelBtn').disabled = false;
          } else {
            alert('No readable text extracted.');
          }
        } catch (error) {
          console.error('Error extracting PDF data:', error);
          alert('Failed to extract data. Check the console for details.');
        }
      }
    });

    function cleanText(text) {
      // Remove specific text patterns without leaving a gap or inserting "null"
      text = text.replace(/State\s+of\s+South\s+Dakota\s+Department\s+of\s+Health/gi, '');
      text = text.replace(/600\s+E\s+Capitol\s+Ave/gi, '');
      text = text.replace(/Pierre,\s+SD\s+57501/gi, '');
      return text;
    }

    function exportToExcel() {
      if (sheets.length === 0) {
        alert('No data to export.');
        return;
      }

      const wb = XLSX.utils.book_new();

      // Create a new sheet for each set of extracted data
      sheets.forEach((sheetData, index) => {
        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        XLSX.utils.book_append_sheet(wb, ws, `Invoice ${index + 1}`);
      });

      // Save the workbook as an Excel file
      XLSX.writeFile(wb, "Invoice_Statement.xlsx");
    }
  </script>

</body>
</html>
