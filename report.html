<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Template Filler</title>
</head>
<body>
    <h1>PDF Template Filler</h1>
    
    <!-- ✅ Upload button for the data source -->
    <input type="file" id="dataFileInput" accept="application/pdf" />
    <button id="fillTemplateButton">Fill Template and Download</button>

    <!-- ✅ Load pdf-lib and pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.11.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <script>
        let extractedData = {};

        // ✅ Handle file upload and extract data
        document.getElementById('dataFileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // ✅ Check file type
            if (file.type !== 'application/pdf') {
                alert('Please upload a valid PDF file.');
                console.error('Invalid file type:', file.type);
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const pdfBytes = new Uint8Array(e.target.result);

                    console.log('PDF file loaded successfully. Size:', pdfBytes.length, 'bytes');

                    // ✅ Load PDF using PDF.js
                    const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const textContent = await page.getTextContent();

                    console.log('Extracted text content:', textContent.items.map(i => i.str));

                    // ✅ Example of how to parse extracted data
                    extractedData.clientName = textContent.items.find(i => i.str.includes("Client Name"))?.str.split(':')[1]?.trim() || 'N/A';
                    extractedData.clientID = textContent.items.find(i => i.str.includes("Client ID"))?.str.split(':')[1]?.trim() || 'N/A';
                    extractedData.statementDate = textContent.items.find(i => i.str.includes("Statement Date"))?.str.split(':')[1]?.trim() || 'N/A';
                    extractedData.amountToPay = textContent.items.find(i => i.str.includes("PAY THIS AMOUNT"))?.str.split(':')[1]?.trim() || 'N/A';

                    console.log("Extracted Data:", extractedData);
                    alert("Data extracted successfully! Click 'Fill Template and Download'");
                } catch (error) {
                    console.error('Failed to parse PDF file:', error);
                    alert(`Failed to parse PDF file. Error: ${error.message}`);
                }
            };

            reader.readAsArrayBuffer(file);
        });

        // ✅ Fill the template and download
        document.getElementById('fillTemplateButton').addEventListener('click', async () => {
            try {
                if (!extractedData.clientName) {
                    alert("Please upload a valid PDF first!");
                    return;
                }

                // ✅ Load the statementpdf.pdf template
                const templateUrl = './statementpdf.pdf';
                const templateBytes = await fetch(templateUrl).then(res => res.arrayBuffer());

                const pdfDoc = await PDFLib.PDFDocument.load(templateBytes);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];

                const { width, height } = firstPage.getSize();
                const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

                // ✅ Insert extracted data into the template at specific coordinates
                firstPage.drawText(`${extractedData.clientName}`, {
                    x: 150,
                    y: height - 150,
                    size: 12,
                    font: helveticaFont,
                    color: PDFLib.rgb(0, 0, 0),
                });

                firstPage.drawText(`${extractedData.clientID}`, {
                    x: 150,
                    y: height - 170,
                    size: 12,
                    font: helveticaFont,
                    color: PDFLib.rgb(0, 0, 0),
                });

                firstPage.drawText(`${extractedData.statementDate}`, {
                    x: 450,
                    y: height - 150,
                    size: 12,
                    font: helveticaFont,
                    color: PDFLib.rgb(0, 0, 0),
                });

                firstPage.drawText(`${extractedData.amountToPay}`, {
                    x: 450,
                    y: height - 170,
                    size: 12,
                    font: helveticaFont,
                    color: PDFLib.rgb(0, 0, 0),
                });

                // ✅ Save the filled PDF
                const modifiedPdfBytes = await pdfDoc.save();

                // ✅ Trigger download
                const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'filled_template.pdf';
                document.body.appendChild(link);
                link.click();

                // ✅ Clean up
                URL.revokeObjectURL(url);
                console.log('PDF successfully created.');
            } catch (error) {
                console.error('Error processing file:', error);
                alert(`Error: ${error.message}`);
            }
        });
    </script>
</body>
</html>
